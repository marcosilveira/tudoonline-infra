#!/usr/bin/env groovy
pipeline {
  environment { 
    DOCKER_REGISTRY = 'ghcr.io'
    GITHUB_ORG = 'marcosilveira'
    APP_NAME = 'goolhub-api'
    NAMESPACE = 'production'
    GITHUB_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // AWS / Helm Config (Legacy from original file)
    AWS_REGION = "us-east-1"
    AWS_ACCOUNT_ID = '967910066457'
    AWS_ROLE_ARN = "arn:aws:iam::967910066457:role/goolhub-api-production"
    HELM_CHART_NAME = 'goolhub'
    HELM_REPO_CUSTOM_NAME = 'tudoonline-stable'
    HELM_REPO_CUSTOM_URL = 's3://tudoonline-helm-charts/stable'
    HELM_TIMEOUT = '600s'
    // App Repo
    APP_REPO_URL = 'https://github.com/tudoonlineteam/goolhub-api.git'
    APP_BRANCH = 'master'
    GIT_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
  } 

  options { 
    timeout(time: 30, unit: 'MINUTES') 
  } 

  triggers {
    GenericTrigger(
      genericVariables: [
        [key: 'ref', value: '$.ref']
      ],
      token: 'goolhub-api-token',
      causeString: 'Triggered by GitHub Webhook',
      printContributedVariables: true,
      printPostContent: true,
      regexpFilterText: '$ref',
      regexpFilterExpression: 'refs/heads/master'
    )
  }

  agent any

  stages {
    stage('Checkout App Code') {
      steps {
        script {
           echo "Cloning Application Code..."
           dir('app') {
             git branch: APP_BRANCH, url: APP_REPO_URL, credentialsId: GIT_CREDENTIAL_ID
           }
        }
      }
    }

    stage('Login to GitHub Container Registry') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: "${GITHUB_CREDENTIAL_ID}", usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
            sh """
              echo \$GITHUB_TOKEN | docker login ${DOCKER_REGISTRY} -u \$GITHUB_USER --password-stdin
            """
          }
        }
      }
    }

    stage('Build Docker Images') {
      parallel {
        stage('Build Nginx') {
          steps {
            script {
              sh """
                docker build --network host -t ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} -f goolhub-api/docker/nginx/Dockerfile .
                docker tag ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:latest
              """
            }
          }
        }
        
        stage('Build PHP') {
          steps {
            script {
              sh """
                docker build --network host -t ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} -f goolhub-api/docker/php/Dockerfile .
                docker tag ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:latest
              """
            }
          }
        }
        
        stage('Build Generic/Build') {
          steps {
             script {
                // Mantendo build da imagem 'build' caso seja usada por algum job
                sh """
                  docker build --network host -t ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-build:${BUILD_NUMBER} -f goolhub-api/docker/build/Dockerfile .
                  docker tag ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-build:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-build:latest
                """
             }
          }
        }
      }
    }

    stage('Push Images') {
      steps {
        script {
          sh """
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER}
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:latest
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER}
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:latest
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-build:${BUILD_NUMBER}
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-build:latest
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
           // Necess√°rio setup do helm repo S3 (usando credenciais AWS impl√≠citas/agent)
           withEnv(["AWS_ROLE_ARN=${AWS_ROLE_ARN}", "AWS_REGION=${AWS_REGION}"]) {
             sh """
                # Adicionar repo customizado (S3)
                helm repo add ${HELM_REPO_CUSTOM_NAME} ${HELM_REPO_CUSTOM_URL} || true
                helm repo update
                
                # Update no Release usando Chart Remoto e Values Locais
                helm upgrade --install ${APP_NAME} \
                  --namespace ${NAMESPACE} \
                  -f goolhub-api/helm-values-production.yaml \
                  ${HELM_REPO_CUSTOM_NAME}/${HELM_CHART_NAME} \
                  --set app.nginx.image.repository=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx \
                  --set app.nginx.image.tag=${BUILD_NUMBER} \
                  --set app.php.image.repository=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php \
                  --set app.php.image.tag=${BUILD_NUMBER} \
                  --wait --timeout ${HELM_TIMEOUT} --atomic
             """
           }
        }
      }
    }
  }
  
  post {
    success {
      echo "Deploy realizado com sucesso! üöÄ"
    }
    
    failure {
      echo "Deploy falhou! ‚ùå"
    }
    
    always {
      sh """
        docker rmi ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} || true
        docker rmi ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} || true
        docker rmi ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-build:${BUILD_NUMBER} || true
      """
    }
  }
}
