#!/usr/bin/env groovy
// ============================================================
// Trigger via curl:
//
// curl -X POST --user marco_silveira:API_TOKEN \
//   "http://217.216.81.157:30808/job/Projects/job/tudoonline/job/customer-ingress/job/Deploy%20-%20Customer%20Ingress/build?token=3UodgmPPfWK187PY5UaLFNYd0FcJmvvO"
//
// Nota: substituir API_TOKEN pelo token gerado em Jenkins > Avatar > Security > API Token
// ============================================================
pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: slave
spec:
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"
  - name: kubectl
    image: alpine:3.18
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "500m"
  volumes:
  - name: workspace-volume
    emptyDir:
      medium: Memory
      sizeLimit: 512Mi
"""
    }
  }

  environment {
    NAMESPACE = "production"
    URL_HOSTS = "https://goolhub.io/Sistema/customer-ingress/hosts.php"
    INGRESS_NAME = "tudoonline-app-customer-ingress"
    SERVICE_NAME = "tudoonline-app"
    SERVICE_PORT = "80"
  }

  options {
    timeout(time: 30, unit: 'MINUTES')
    disableConcurrentBuilds()
  }

  stages {
    stage('Checkout') {
      steps {
        container('jnlp') {
          checkout scm
        }
      }
    }

    stage('Initialize') {
      steps {
        container('kubectl') {
          sh """
            echo "### Installing dependencies ###"
            apk add -q --no-cache jq curl bind-tools bash

            echo "### Installing kubectl ###"
            curl -LO "https://dl.k8s.io/release/\$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/
            kubectl version --client
          """
        }
      }
    }

    stage('Get domain list') {
      steps {
        container('kubectl') {
          sh """
            echo "### Fetching customer host list from API ###"
            curl --silent --show-error --fail \\
              -H "Content-Type: application/json" \\
              ${URL_HOSTS} > hosts-raw.json

            echo "### Response from API: ###"
            cat hosts-raw.json

            echo "### Generating ingress YAML ###"
            bash tudoonline-app-customer-ingress/generate-ingress.sh > ingress-production.yaml

            echo "### Generated ingress YAML: ###"
            cat ingress-production.yaml
          """
        }
      }
    }

    stage('Check DNS') {
      steps {
        container('kubectl') {
          sh "bash tudoonline-app-customer-ingress/check-dns.sh"
        }
      }
    }

    stage('Deploy') {
      steps {
        container('kubectl') {
          sh """
            echo "### Applying customer ingress to cluster ###"
            kubectl apply -f ingress-production.yaml -n ${NAMESPACE}

            echo ""
            echo "### Current ingress state: ###"
            kubectl get ingress -n ${NAMESPACE} ${INGRESS_NAME}

            echo ""
            echo "### Certificate status: ###"
            kubectl get certificate -n ${NAMESPACE}
          """
        }
      }
    }
  }

  post {
    success {
      echo "### Customer ingress deployed successfully! Certificates will be issued automatically by cert-manager. ###"
    }
    failure {
      echo "### Deployment FAILED! Check the logs above. ###"
    }
  }
}