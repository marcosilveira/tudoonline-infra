#!/usr/bin/env groovy
pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: slave
spec:
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.14.0-debug
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    - name: ghcr-secret
      mountPath: /kaniko/.docker
  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir:
      medium: Memory
      sizeLimit: 4Gi
  - name: ghcr-secret
    secret:
      secretName: ghcr-secret
      items:
        - key: .dockerconfigjson
          path: config.json
"""
    }
  }

  environment { 
    DOCKER_REGISTRY = 'ghcr.io'
    GITHUB_ORG = 'marcosilveira'
    APP_NAME = 'tudoonline-app'
    NAMESPACE = 'production'
    GITHUB_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // App Repo
    APP_REPO_URL = 'https://github.com/tudoonline/legadogool.git'
    APP_BRANCH = 'master'
    GIT_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // Secrets
    GIT_CRYPT_KEY = 'tudoonline-legadogool-secretkey-git-crypt'
  } 

  options { 
    timeout(time: 60, unit: 'MINUTES') 
  } 

  triggers {
    GenericTrigger(
      genericVariables: [
        [key: 'ref', value: '$.ref']
      ],
      token: 'tudoonline-app-token',
      causeString: 'Triggered by GitHub Webhook',
      printContributedVariables: true,
      printPostContent: true,
      regexpFilterText: '$ref',
      regexpFilterExpression: 'refs/heads/master'
    )
  }

  stages {
    stage('Checkout App Code') {
      steps {
        container('jnlp') {
          script {
             echo "Cloning Application Code..."
             dir('app') {
               git branch: APP_BRANCH, url: APP_REPO_URL, credentialsId: GIT_CREDENTIAL_ID
             }
          }
        }
      }
    }

    stage('Decrypt Config Files') {
      steps {
        container('jnlp') {
          script {
            dir('app') {
              withCredentials([file(credentialsId: "${GIT_CRYPT_KEY}", variable: 'DECRYPT_KEY')]) {
                sh """
                  if [ -d ".git-crypt" ]; then
                     if command -v git-crypt &> /dev/null; then
                         git-crypt unlock "\$DECRYPT_KEY"
                         echo "Reposit√≥rio descriptografado."
                     else
                         echo "WARN: git-crypt nao encontrado. Pulando descriptografia."
                     fi
                  else
                     echo "git-crypt n√£o detectado no reposit√≥rio."
                  fi
                  
                  if [ "${NAMESPACE}" = "production" ] && [ -f ".env_production" ]; then
                    mv .env_production config.php
                  elif [ "${NAMESPACE}" = "staging" ] && [ -f ".env_staging" ]; then
                    mv .env_staging config.php
                  fi
                """
              }
            }
          }
        }
      }
    }

    stage('Build & Push Docker Images (Kaniko)') {
      parallel {
        stage('Build Nginx') {
          steps {
            container('kaniko') {
              script {
                sh """
                  /kaniko/executor \
                    --context . \
                    --dockerfile ./tudoonline-app/docker/nginx/Dockerfile \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:latest \
                    --cache=true
                """
              }
            }
          }
        }
        
        stage('Build PHP') {
          steps {
            container('kaniko') {
              script {
                sh """
                  /kaniko/executor \
                    --context . \
                    --dockerfile ./tudoonline-app/docker/php/Dockerfile \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:latest \
                    --cache=true
                """
              }
            }
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        container('kubectl') {
          script {
            sh """
              # Aplicar manifestos Kubernetes da pasta de infraestrutura
              kubectl apply -f tudoonline-app/k8s/ -n ${NAMESPACE}
              
              # Atualizar imagens no deployment
              kubectl set image deployment/${APP_NAME} \
                nginx=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} \
                php=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} \
                -n ${NAMESPACE}
                
              # Aguardar rollout
              kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=10m
            """
          }
        }
      }
    }
  }
  
  post {
    success {
      echo "Deploy realizado com sucesso! üöÄ"
    }
    failure {
      echo "Deploy falhou! ‚ùå"
    }
  }
}
