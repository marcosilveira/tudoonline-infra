#!/usr/bin/env groovy
pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: slave
spec:
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:4.11-1-jdk11
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: docker
    image: docker:24.0.5-cli
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    - name: docker-sock
      mountPath: /var/run/docker.sock
  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  volumes:
  - name: workspace-volume
    emptyDir:
      medium: Memory
      sizeLimit: 4Gi
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
"""
    }
  }

  environment { 
    DOCKER_REGISTRY = 'ghcr.io'
    GITHUB_ORG = 'marcosilveira'
    APP_NAME = 'tudoonline-app'
    NAMESPACE = 'production'
    GITHUB_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // App Repo
    APP_REPO_URL = 'https://github.com/tudoonline/legadogool.git'
    APP_BRANCH = 'master'
    GIT_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // Secrets
    GIT_CRYPT_KEY = 'tudoonline-legadogool-secretkey-git-crypt'
  } 

  options { 
    timeout(time: 60, unit: 'MINUTES') 
  } 

  triggers {
    GenericTrigger(
      genericVariables: [
        [key: 'ref', value: '$.ref']
      ],
      token: 'tudoonline-app-token',
      causeString: 'Triggered by GitHub Webhook',
      printContributedVariables: true,
      printPostContent: true,
      regexpFilterText: '$ref',
      regexpFilterExpression: 'refs/heads/master'
    )
  }

  stages {
    stage('Checkout App Code') {
      steps {
        container('jnlp') {
          script {
             echo "Cloning Application Code..."
             dir('app') {
               git branch: APP_BRANCH, url: APP_REPO_URL, credentialsId: GIT_CREDENTIAL_ID
             }
          }
        }
      }
    }

    stage('Decrypt Config Files') {
      steps {
        container('jnlp') {
          script {
            dir('app') {
              withCredentials([file(credentialsId: "${GIT_CRYPT_KEY}", variable: 'DECRYPT_KEY')]) {
                sh """
                  if [ -d ".git-crypt" ]; then
                     # Tenta usar git-crypt se instalado, senao avisa (a imagem jnlp pode nao ter)
                     if command -v git-crypt &> /dev/null; then
                         git-crypt unlock "\$DECRYPT_KEY"
                         echo "Reposit√≥rio descriptografado."
                     else
                         echo "WARN: git-crypt nao encontrado no container jnlp. Pulando descriptografia."
                     fi
                  else
                     echo "git-crypt n√£o detectado no reposit√≥rio."
                  fi
                  
                  if [ "${NAMESPACE}" = "production" ] && [ -f ".env_production" ]; then
                    mv .env_production config.php
                  elif [ "${NAMESPACE}" = "staging" ] && [ -f ".env_staging" ]; then
                    mv .env_staging config.php
                  fi
                """
              }
            }
          }
        }
      }
    }

    stage('Login to GitHub Container Registry') {
      steps {
        container('docker') {
          script {
            withCredentials([usernamePassword(credentialsId: "${GITHUB_CREDENTIAL_ID}", usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
              sh """
                echo \$GITHUB_TOKEN | docker login ${DOCKER_REGISTRY} -u \$GITHUB_USER --password-stdin
              """
            }
          }
        }
      }
    }

    stage('Build Docker Images') {
      parallel {
        stage('Build Nginx') {
          steps {
            container('docker') {
              script {
                sh """
                  docker build --network host -t ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} -f tudoonline-app/docker/nginx/Dockerfile .
                  docker tag ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:latest
                """
              }
            }
          }
        }
        
        stage('Build PHP') {
          steps {
            container('docker') {
              script {
                sh """
                  docker build --network host -t ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} -f tudoonline-app/docker/php/Dockerfile .
                  docker tag ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:latest
                """
              }
            }
          }
        }
      }
    }

    stage('Push Images') {
      steps {
        container('docker') {
          script {
            sh """
              docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER}
              docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:latest
              docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER}
              docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:latest
            """
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        container('kubectl') {
          script {
            sh """
              # Aplicar manifestos Kubernetes da pasta de infraestrutura
              kubectl apply -f tudoonline-app/k8s/ -n ${NAMESPACE}
              
              # Atualizar imagens no deployment
              kubectl set image deployment/${APP_NAME} \
                nginx=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} \
                php=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} \
                -n ${NAMESPACE}
                
              # Aguardar rollout
              kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=10m
            """
          }
        }
      }
    }
  }
  
  post {
    success {
      echo "Deploy realizado com sucesso! üöÄ"
    }
    
    failure {
      echo "Deploy falhou! ‚ùå"
    }
    
    always {
      container('docker') {
        sh """
          docker rmi ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} || true
          docker rmi ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} || true
        """
      }
    }
  }
}
