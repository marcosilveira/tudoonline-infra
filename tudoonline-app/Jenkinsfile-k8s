#!/usr/bin/env groovy
pipeline {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: slave
spec:
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1"
  # Container dedicado para build do Nginx
  - name: kaniko-nginx
    image: gcr.io/kaniko-project/executor:v1.14.0-debug
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    - name: ghcr-secret
      mountPath: /kaniko/.docker
    resources:
      requests:
        memory: "2Gi"
        cpu: "1"
      limits:
        memory: "4Gi"
        cpu: "2"
  # Container dedicado para build do PHP
  - name: kaniko-php
    image: gcr.io/kaniko-project/executor:v1.14.0-debug
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    - name: ghcr-secret
      mountPath: /kaniko/.docker
    resources:
      requests:
        memory: "4Gi"
        cpu: "2"
      limits:
        memory: "6Gi"
        cpu: "4"
  # Container gen√©rico para rodar kubectl via download
  - name: kubectl
    image: alpine:3.18
    command:
    - cat
    tty: true
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "500m"
  volumes:
  - name: workspace-volume
    emptyDir:
      medium: Memory
      sizeLimit: 4Gi
  - name: ghcr-secret
    secret:
      secretName: ghcr-secret
      items:
        - key: .dockerconfigjson
          path: config.json
"""
    }
  }

  environment { 
    DOCKER_REGISTRY = 'ghcr.io'
    GITHUB_ORG = 'marcosilveira'
    APP_NAME = 'tudoonline-app'
    NAMESPACE = 'production'
    GITHUB_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // App Repo
    APP_REPO_URL = 'https://github.com/tudoonline/legadogool.git'
    APP_BRANCH = 'master'
    GIT_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // Secrets
    GIT_CRYPT_KEY = 'tudoonline-legadogool-secretkey-git-crypt'
  } 

  options { 
    timeout(time: 60, unit: 'MINUTES') 
  } 

  triggers {
    GenericTrigger(
      genericVariables: [
        [key: 'ref', value: '$.ref']
      ],
      token: 'tudoonline-app-token',
      causeString: 'Triggered by GitHub Webhook',
      printContributedVariables: true,
      printPostContent: true,
      regexpFilterText: '$ref',
      regexpFilterExpression: 'refs/heads/master'
    )
  }

  stages {
    stage('Checkout App Code') {
      steps {
        container('jnlp') {
          script {
             echo "Cloning Application Code..."
             dir('app') {
               git branch: APP_BRANCH, url: APP_REPO_URL, credentialsId: GIT_CREDENTIAL_ID
             }
          }
        }
      }
    }

    stage('Decrypt & Prepare') {
      steps {
        container('jnlp') {
          script {
            // Copiar arquivo de configura√ß√£o criptografado da infra para o app
            // O Jenkins j√° desencriptou o repo `tudoonline-infra` no checkout inicial
            // se a credencial git-crypt estiver configurada globalmente ou no checkout.
            // Se n√£o, precisamos garantir o unlock aqui, mas geralmente o checkout SCM j√° resolve se configurado.
            // Para seguran√ßa, vamos garantir que o arquivo existe.
            
            sh """
              if [ -f "tudoonline-app/config/config.php" ]; then
                  echo "Copiando config.php da infra..."
                  cp tudoonline-app/config/config.php app/config.php
              else
                  echo "ERRO: tudoonline-app/config/config.php n√£o encontrado na infra!"
                  exit 1
              fi
            """
            
            // Limpeza sequencial segura antes dos builds paralelos
            sh "rm -rf app/mercadopago/vendor/mercadopago/dx-php/.phpdoc || true"
            echo "Limpeza e Configura√ß√£o conclu√≠da."
          }
        }
      }
    }

    stage('Build Docker Images (Kaniko)') {
      parallel {
        stage('Build Nginx') {
          steps {
            container('kaniko-nginx') {
              script {
                sh """
                  /kaniko/executor \
                    --context . \
                    --dockerfile ./tudoonline-app/docker/nginx/Dockerfile \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:latest \
                    --cache=true \
                    --compressed-caching=false
                """
              }
            }
          }
        }
        
        stage('Build PHP') {
          steps {
            container('kaniko-php') {
              script {
                sh """
                  /kaniko/executor \
                    --context . \
                    --dockerfile ./tudoonline-app/docker/php/Dockerfile \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} \
                    --destination ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:latest \
                    --cache=true \
                    --compressed-caching=false
                """
              }
            }
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        container('kubectl') {
          script {
            sh """
              echo "Installing kubectl dependencies..."
              apk add --no-cache curl
              
              echo "Downloading kubectl..."
              curl -LO "https://dl.k8s.io/release/\$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x kubectl
              mv kubectl /usr/local/bin/
              
              kubectl version --client
              
              echo "Applying Kubernetes manifests..."
              kubectl apply -f tudoonline-app/k8s/ -n ${NAMESPACE}
              
              echo "Updating deployment images..."
              kubectl set image deployment/${APP_NAME} \
                nginx=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-nginx:${BUILD_NUMBER} \
                php=${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}-php:${BUILD_NUMBER} \
                -n ${NAMESPACE}
                
              echo "Waiting for rollout..."
              if ! kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE} --timeout=20m; then
                  echo "Rollout failed or timed out. Debugging info:"
                  kubectl get pods -n ${NAMESPACE}
                  kubectl describe deployment/${APP_NAME} -n ${NAMESPACE}
                  exit 1
              fi
            """
          }
        }
      }
    }
  }
  
  post {
    success {
      echo "Deploy realizado com sucesso! üöÄ"
    }
    failure {
      echo "Deploy falhou! ‚ùå"
    }
  }
}
