#!/usr/bin/env groovy
pipeline {
  environment { 
    DOCKER_REGISTRY = 'ghcr.io'
    GITHUB_ORG = 'marcosilveira'
    APP_NAME = 'tudoonline-workers'
    NAMESPACE = 'production'
    GITHUB_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
    // Caminho relativo √† raiz do reposit√≥rio de infra
    HELM_CHART_PATH = "tudoonline-workers/k8s"
    HELM_TIMEOUT = '600s'
    // Defini√ß√£o do reposit√≥rio da aplica√ß√£o
    APP_REPO_URL = 'https://github.com/tudoonline/legadogool-workers.git'
    APP_BRANCH = 'master'
    GIT_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c'
  } 

  options { 
    timeout(time: 30, unit: 'MINUTES') 
  } 

  triggers {
    GenericTrigger(
      genericVariables: [
        [key: 'ref', value: '$.ref']
      ],
      token: 'tudoonline-workers-token',
      causeString: 'Triggered by GitHub Webhook',
      printContributedVariables: true,
      printPostContent: true,
      regexpFilterText: '$ref',
      regexpFilterExpression: 'refs/heads/master'
    )
  }

  agent any

  stages {
    stage('Checkout App Code') {
      steps {
        script {
           // O Jenkinsfile j√° est√° no repo de infra, ent√£o o workspace tem os arquivos de infra.
           // Precisamos baixar o c√≥digo da aplica√ß√£o na pasta 'app' para o Dockerfile usar.
           
           echo "Cloning Application Code..."
           dir('app') {
             git branch: APP_BRANCH, url: APP_REPO_URL, credentialsId: GIT_CREDENTIAL_ID
           }
        }
      }
    }

    stage('Login to GitHub Container Registry') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: "${GITHUB_CREDENTIAL_ID}", usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
            sh """
              echo \$GITHUB_TOKEN | docker login ${DOCKER_REGISTRY} -u \$GITHUB_USER --password-stdin
            """
          }
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          // O build roda na raiz do workspace (infra). O Dockerfile est√° em tudoonline-workers/docker/worker/Dockerfile
          // O contexto (.) cont√©m a pasta 'app' que acabamos de baixar.
          sh """
            if [ -f "tudoonline-workers/config/config.php" ]; then
                echo "Copiando config.php da infra..."
                cp tudoonline-workers/config/config.php app/config.php
            else
                echo "AVISO: tudoonline-workers/config/config.php n√£o encontrado!"
            fi
            
            docker build --network host -t ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:${BUILD_NUMBER} -f tudoonline-workers/docker/worker/Dockerfile .
            docker tag ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:${BUILD_NUMBER} ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:latest
          """
        }
      }
    }

    stage('Push Images') {
      steps {
        script {
          sh """
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:${BUILD_NUMBER}
            docker push ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:latest
          """
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          sh """
            # Update image tag in values file
            sed -i 's|image:.*|image: ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:${BUILD_NUMBER}|g' ${HELM_CHART_PATH}/helm-values-production.yaml
            
            # Deploy with Helm
            helm upgrade --install tudoonline-workers \
              --namespace ${NAMESPACE} \
              -f ${HELM_CHART_PATH}/helm-values-production.yaml \
              ${HELM_CHART_PATH} \
              --wait --timeout ${HELM_TIMEOUT} --atomic
          """
        }
      }
    }
  }
  
  post {
    success {
      echo "Deploy realizado com sucesso! üöÄ"
      echo "Imagem: ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:${BUILD_NUMBER}"
    }
    
    failure {
      echo "Deploy falhou! ‚ùå"
    }
    
    always {
      sh """
        docker rmi ${DOCKER_REGISTRY}/${GITHUB_ORG}/${APP_NAME}:${BUILD_NUMBER} || true
      """
    }
  }
}
