pipeline {
  triggers {
    GenericTrigger(
     genericVariables: [
      [key: 'ref', value: '$.ref']
     ],
     token: 'tudoonline-workers-prod2-token',
     causeString: 'Triggered by GitHub Webhook',
     printContributedVariables: true,
     printPostContent: true,
     regexpFilterText: '$ref',
     regexpFilterExpression: 'prod2$'
    )
  }
  agent any
  environment {
    // Configurações do Repositório
    GIT_REPO_URL = 'https://github.com/tudoonline/legadogool-workers.git'
    GIT_BRANCH = 'prod2' // Branch específica
    
    // Credenciais
    GITHUB_CREDENTIAL_ID = '7695161b-5a4b-49a9-a5a9-86c1b6f2bf1c' 
    KUBECONFIG_ID = 'kubeconfig-production'
    
    // Imagem Docker (Tag específica para prod2)
    DOCKER_IMAGE = 'ghcr.io/marcosilveira/tudoonline-workers'
    DOCKER_TAG = 'prod2'
  }
  
  stages {
    stage('Checkout Infra') {
      steps {
        checkout scm
      }
    }
    
    stage('Checkout App Code (Prod2)') {
      steps {
        script {
          echo "Cloning Application Code (Branch: ${GIT_BRANCH})..."
          dir('app') {
            git branch: "${GIT_BRANCH}",
                url: "${GIT_REPO_URL}",
                credentialsId: "${GITHUB_CREDENTIAL_ID}"
          }
        }
      }
    }
    
    stage('Login to GHCR') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: "${GITHUB_CREDENTIAL_ID}", usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_TOKEN')]) {
            sh 'echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_USER --password-stdin'
          }
        }
      }
    }
    
    stage('Build Docker Image') {
      steps {
        script {
          // O build roda na raiz do workspace (infra). O Dockerfile está em tudoonline-workers/docker/worker/Dockerfile
          // O contexto (.) contém a pasta 'app' que baixamos do repo da aplicação
          sh """
            if [ -f "tudoonline-workers/config/config.php" ]; then
                echo "Copiando config.php da infra..."
                cp tudoonline-workers/config/config.php app/config.php
            else
                echo "AVISO: tudoonline-workers/config/config.php não encontrado!"
            fi
            
            docker build --network host -t ${DOCKER_IMAGE}:${DOCKER_TAG} -f tudoonline-workers/docker/worker/Dockerfile.prod2 .
          """
        }
      }
    }

    stage('Push Docker Image') {
      steps {
        script {
          sh "docker push ${DOCKER_IMAGE}:${DOCKER_TAG}"
        }
      }
    }
    
    stage('Deploy to Kubernetes (Helm)') {
      steps {
        script {
            // Usa o Helm assumindo que o ambiente já tem permissões (ServiceAccount)
            sh """
              helm upgrade --install tudoonline-workers-prod2 ./tudoonline-workers/k8s \
                --namespace production \
                --values ./tudoonline-workers/k8s/helm-values-prod2.yaml \
                --set worker.image=${DOCKER_IMAGE}:${DOCKER_TAG}
            """
        }
      }
    }
  }
  
  post {
    always {
      echo "Deploy Prod2 Finalizado!"
      // Limpeza de imagens Docker locais para economizar espaço no Jenkins
      sh "docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true"
    }
  }
}
