# Herda de production, mas sobrescreve para Prod2 Dedicated
# Configuração SSH para Debug (Apenas Prod2)
ssh:
  enabled: true
  nodePort: 30022

# Configuração HTTP Built-in (Apenas Prod2 para o crontab local apontar pra ela)
httpService:
  enabled: true

worker:
  defaults:
    image: ghcr.io/marcosilveira/tudoonline-workers:prod2
    
    # Força os pods a rodarem SOMENTE na VPS Dedicada (vmi3070952 / 217.216.82.188)
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: role
                  operator: In
                  values:
                    - worker-dedicated
    
    # Permite rodar no node com Taint dedicado (dedicado à workers)
    tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "worker"
        effect: "NoSchedule"

  workers:
    # Worker Sentinela para Crons Manuais (Nunca morre, não depende de fila)
    # Use este container para rodar 'crictl exec ...' via SSH
    - name: cron-runner
      # Inicia o SSHD automaticamente e o PHP built-in server na porta 80 em background
      command: ["/bin/sh", "-c", "set -e; apk update; apk add openssh; mkdir -p /root/.ssh; chmod 700 /root/.ssh; ssh-keygen -A; echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config; echo 'root:tudoonline' | chpasswd; echo 'cd /app' >> /root/.profile; echo 'export EDITOR=nano' >> /root/.profile; mkdir -p /run/sshd; crontab /etc/cron/crontab.txt; crond; php -S 0.0.0.0:80 -t /app & exec /usr/sbin/sshd -D"]
      securityContext:
        runAsUser: 0
      ports:
        - containerPort: 22
          name: ssh
        - containerPort: 80
          name: http
      replicaCount: 1
      minReplicaCount: 1
      maxReplicaCount: 1
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
      persistence:
        - name: imagens
          existingClaim: tudoonline-app-imagens
          mountPath: /app/imagens/
        - name: etiquetas
          existingClaim: tudoonline-app-etiquetas
          mountPath: /app/etiquetas/
      # Sem KEDA triggers, para ficar sempre ligado.

    # Lista de Workers Normais (Herda do original se fosse merge, mas Helm Value sobrescreve lista)
    # PRECISAREMOS COPIAR A LISTA INTEIRA DO production AQUI SE QUISERMOS RODAR TODOS.
    # Como não sei se você quer rodar TODOS os workers na prod2 ou só alguns, 
    # vou deixar apenas o cron-runner por enquanto para testarmos a conexão.
    # DEPOIS, copiamos a lista gigante do helm-values-production.yaml pra cá.
