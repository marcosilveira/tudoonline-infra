{{- if .Values.worker.enabled }}
{{- range .Values.worker.workers }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $.Values.worker.defaults.namePrefix }}{{ .name }}
  namespace: {{ $.Values.namespace }}
  labels:
    app: {{ $.Values.worker.defaults.namePrefix }}{{ .name }}
spec:
  replicas: {{ .replicaCount | default 0 }}
  selector:
    matchLabels:
      app: {{ $.Values.worker.defaults.namePrefix }}{{ .name }}
  strategy:
    {{- toYaml $.Values.worker.defaults.updateStrategy | nindent 4 }}
  template:
    metadata:
      labels:
        app: {{ $.Values.worker.defaults.namePrefix }}{{ .name }}
      {{- with $.Values.worker.defaults.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ $.Values.worker.defaults.serviceAccountName | default "default" }}
      {{- with $.Values.worker.defaults.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.worker.defaults.dnsConfig }}
      dnsConfig:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .affinity | default $.Values.worker.defaults.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $.Values.worker.defaults.schedulerName }}
      schedulerName: {{ . }}
      {{- end }}
      {{- with .tolerations | default $.Values.worker.defaults.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: worker
        image: {{ $.Values.worker.defaults.image }}
        imagePullPolicy: Always
        command: {{ .command | toJson }}
        args: {{ .args | toJson }}
        {{- if .ports }}
        ports:
          {{- toYaml .ports | nindent 10 }}
        {{- end }}
        {{- with .resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- if .persistence }}
        volumeMounts:
        - name: app-config
          mountPath: /app/config.php
          subPath: config.php
        - name: app-config
          mountPath: /app/config_rabbit.php
          subPath: config_rabbit.php
        - name: app-config
          mountPath: /app/crons/config_cron.php
          subPath: config_cron.php
        - name: app-config
          mountPath: /app/crons/config_rbt.php
          subPath: config_rbt.php
        - name: app-config
          mountPath: /etc/cron/crontab.txt
          subPath: crontab
        {{- range .persistence }}
        - name: {{ .name }}
          mountPath: {{ .mountPath }}
        {{- end }}
        {{- else }}
        volumeMounts:
        - name: app-config
          mountPath: /app/config.php
          subPath: config.php
        - name: app-config
          mountPath: /app/config_rabbit.php
          subPath: config_rabbit.php
        - name: app-config
          mountPath: /app/crons/config_cron.php
          subPath: config_cron.php
        - name: app-config
          mountPath: /app/crons/config_rbt.php
          subPath: config_rbt.php
        - name: app-config
          mountPath: /etc/cron/crontab.txt
          subPath: crontab
        {{- end }}
      {{- if .persistence }}
      volumes:
      - name: app-config
        configMap:
          name: {{ $.Release.Name }}-app-settings
      {{- range .persistence }}
      - name: {{ .name }}
        persistentVolumeClaim:
          claimName: {{ .existingClaim }}
      {{- end }}
      {{- else }}
      volumes:
      - name: app-config
        configMap:
          name: {{ $.Release.Name }}-app-settings
      {{- end }}
{{- if .keda }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $.Values.worker.defaults.namePrefix }}{{ .name }}
  namespace: {{ $.Values.namespace }}
spec:
  scaleTargetRef:
    name: {{ $.Values.worker.defaults.namePrefix }}{{ .name }}
  pollingInterval: {{ .keda.pollingInterval }}
  cooldownPeriod: {{ .keda.cooldownPeriod }}
  minReplicaCount: {{ .keda.minReplicaCount }}
  maxReplicaCount: {{ .keda.maxReplicaCount }}
  {{- with .keda.behavior }}
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        {{- toYaml . | nindent 8 }}
  {{- end }}
  triggers:
  {{- range .keda.triggers }}
  - type: {{ .type }}
    metadata:
      {{- toYaml .metadata | nindent 6 }}
    {{- with .authenticationRef }}
    authenticationRef:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
